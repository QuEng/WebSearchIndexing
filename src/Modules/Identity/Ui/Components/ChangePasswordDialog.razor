@inject HttpClient HttpClient
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-4">Change Password</MudText>
        
        <MudTextField 
            @bind-Value="model.CurrentPassword"
            Label="Current Password"
            InputType="InputType.Password"
            Variant="Variant.Outlined"
            Required="true"
            Class="mb-3"
            Error="@(!string.IsNullOrEmpty(currentPasswordError))"
            ErrorText="@currentPasswordError" />
            
        <MudTextField 
            @bind-Value="model.NewPassword"
            Label="New Password"
            InputType="InputType.Password"
            Variant="Variant.Outlined"
            Required="true"
            Class="mb-3"
            HelperText="Minimum 6 characters"
            Error="@(!string.IsNullOrEmpty(newPasswordError))"
            ErrorText="@newPasswordError"
            @onblur="ValidateNewPassword" />
            
        <MudTextField 
            @bind-Value="model.ConfirmPassword"
            Label="Confirm New Password"
            InputType="InputType.Password"
            Variant="Variant.Outlined"
            Required="true"
            Class="mb-3"
            Error="@(!string.IsNullOrEmpty(confirmPasswordError))"
            ErrorText="@confirmPasswordError"
            @onblur="ValidateConfirmPassword" />

        @if (!string.IsNullOrEmpty(generalError))
        {
            <MudAlert Severity="Severity.Error" Class="mt-3">
                @generalError
            </MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Cancel</MudButton>
        <MudButton 
            Color="Color.Primary" 
            Variant="Variant.Filled"
            OnClick="ChangePassword"
            Disabled="@(!IsFormValid() || isLoading)">
            @if (isLoading)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Changing...</span>
            }
            else
            {
                <span>Change Password</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    
    private ChangePasswordModel model = new();
    private bool isLoading = false;
    
    private string currentPasswordError = string.Empty;
    private string newPasswordError = string.Empty;
    private string confirmPasswordError = string.Empty;
    private string generalError = string.Empty;

    private bool IsFormValid()
    {
        // Clear previous errors
        currentPasswordError = string.Empty;
        newPasswordError = string.Empty;
        confirmPasswordError = string.Empty;

        bool isValid = true;

        if (string.IsNullOrWhiteSpace(model.CurrentPassword))
        {
            isValid = false;
        }

        if (string.IsNullOrWhiteSpace(model.NewPassword))
        {
            isValid = false;
        }
        else if (model.NewPassword.Length < 6)
        {
            isValid = false;
        }

        if (string.IsNullOrWhiteSpace(model.ConfirmPassword))
        {
            isValid = false;
        }
        else if (model.NewPassword != model.ConfirmPassword)
        {
            isValid = false;
        }

        return isValid;
    }

    private void ValidateNewPassword()
    {
        if (string.IsNullOrWhiteSpace(model.NewPassword))
        {
            newPasswordError = "New password is required";
        }
        else if (model.NewPassword.Length < 6)
        {
            newPasswordError = "Password must be at least 6 characters long";
        }
        else
        {
            newPasswordError = string.Empty;
        }
        
        // Also validate confirm password if it's filled
        if (!string.IsNullOrWhiteSpace(model.ConfirmPassword))
        {
            ValidateConfirmPassword();
        }
    }

    private void ValidateConfirmPassword()
    {
        if (string.IsNullOrWhiteSpace(model.ConfirmPassword))
        {
            confirmPasswordError = "Please confirm your new password";
        }
        else if (model.NewPassword != model.ConfirmPassword)
        {
            confirmPasswordError = "Passwords do not match";
        }
        else
        {
            confirmPasswordError = string.Empty;
        }
    }
    
    private async Task ChangePassword()
    {
        // Final validation
        ValidateNewPassword();
        ValidateConfirmPassword();
        
        if (!string.IsNullOrEmpty(currentPasswordError) || 
            !string.IsNullOrEmpty(newPasswordError) || 
            !string.IsNullOrEmpty(confirmPasswordError))
        {
            return;
        }

        try
        {
            isLoading = true;
            generalError = string.Empty;

            var payload = new 
            { 
                currentPassword = model.CurrentPassword, 
                newPassword = model.NewPassword 
            };
            
            var response = await HttpClient.PostAsJsonAsync("/api/v1/identity/users/change-password", payload);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Password changed successfully! You will be logged out.", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                
                // Try to parse error message
                try
                {
                    var errorJson = System.Text.Json.JsonDocument.Parse(errorContent);
                    if (errorJson.RootElement.TryGetProperty("message", out var messageProp))
                    {
                        generalError = messageProp.GetString() ?? "Failed to change password";
                    }
                    else
                    {
                        generalError = "Failed to change password. Please try again.";
                    }
                }
                catch
                {
                    generalError = "Failed to change password. Please try again.";
                }
                
                // Check if it's current password error
                if (generalError.Contains("Current password is incorrect", StringComparison.OrdinalIgnoreCase))
                {
                    currentPasswordError = "Current password is incorrect";
                    generalError = string.Empty;
                }
            }
        }
        catch (Exception ex)
        {
            generalError = $"An unexpected error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private void Cancel() => MudDialog.Cancel();
    
    private class ChangePasswordModel
    {
        public string CurrentPassword { get; set; } = string.Empty;
        public string NewPassword { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
