@inject HttpClient HttpClient
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-4">Change Password</MudText>
        
        <MudTextField 
            @bind-Value="_model.CurrentPassword"
            Label="Current Password"
            InputType="InputType.Password"
            Variant="Variant.Outlined"
            Required="true"
            Class="mb-3"
            Error="@(!string.IsNullOrEmpty(_currentPasswordError))"
            ErrorText="@_currentPasswordError" />
            
        <MudTextField 
            @bind-Value="_model.NewPassword"
            Label="New Password"
            InputType="InputType.Password"
            Variant="Variant.Outlined"
            Required="true"
            Class="mb-3"
            HelperText="Minimum 6 characters"
            Error="@(!string.IsNullOrEmpty(_newPasswordError))"
            ErrorText="@_newPasswordError"
            @onblur="ValidateNewPassword" />
            
        <MudTextField 
            @bind-Value="_model.ConfirmPassword"
            Label="Confirm New Password"
            InputType="InputType.Password"
            Variant="Variant.Outlined"
            Required="true"
            Class="mb-3"
            Error="@(!string.IsNullOrEmpty(_confirmPasswordError))"
            ErrorText="@_confirmPasswordError"
            @onblur="ValidateConfirmPassword" />

        @if (!string.IsNullOrEmpty(_generalError))
        {
            <MudAlert Severity="Severity.Error" Class="mt-3">
                @_generalError
            </MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Cancel</MudButton>
        <MudButton 
            Color="Color.Primary" 
            Variant="Variant.Filled"
            OnClick="ChangePassword"
            Disabled="@(!IsFormValid() || _isLoading)">
            @if (_isLoading)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Changing...</span>
            }
            else
            {
                <span>Change Password</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code
{
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    
    private ChangePasswordModel _model = new();
    private bool _isLoading = false;
    
    private string _currentPasswordError = string.Empty;
    private string _newPasswordError = string.Empty;
    private string _confirmPasswordError = string.Empty;
    private string _generalError = string.Empty;

    private bool IsFormValid()
    {
        // Clear previous errors
        _currentPasswordError = string.Empty;
        _newPasswordError = string.Empty;
        _confirmPasswordError = string.Empty;

        bool isValid = true;

        if (string.IsNullOrWhiteSpace(_model.CurrentPassword))
        {
            isValid = false;
        }

        if (string.IsNullOrWhiteSpace(_model.NewPassword))
        {
            isValid = false;
        }
        else if (_model.NewPassword.Length < 6)
        {
            isValid = false;
        }

        if (string.IsNullOrWhiteSpace(_model.ConfirmPassword))
        {
            isValid = false;
        }
        else if (_model.NewPassword != _model.ConfirmPassword)
        {
            isValid = false;
        }

        return isValid;
    }

    private void ValidateNewPassword()
    {
        if (string.IsNullOrWhiteSpace(_model.NewPassword))
        {
            _newPasswordError = "New password is required";
        }
        else if (_model.NewPassword.Length < 6)
        {
            _newPasswordError = "Password must be at least 6 characters long";
        }
        else
        {
            _newPasswordError = string.Empty;
        }
        
        // Also validate confirm password if it's filled
        if (!string.IsNullOrWhiteSpace(_model.ConfirmPassword))
        {
            ValidateConfirmPassword();
        }
    }

    private void ValidateConfirmPassword()
    {
        if (string.IsNullOrWhiteSpace(_model.ConfirmPassword))
        {
            _confirmPasswordError = "Please confirm your new password";
        }
        else if (_model.NewPassword != _model.ConfirmPassword)
        {
            _confirmPasswordError = "Passwords do not match";
        }
        else
        {
            _confirmPasswordError = string.Empty;
        }
    }
    
    private async Task ChangePassword()
    {
        // Final validation
        ValidateNewPassword();
        ValidateConfirmPassword();
        
        if (!string.IsNullOrEmpty(_currentPasswordError) || 
            !string.IsNullOrEmpty(_newPasswordError) || 
            !string.IsNullOrEmpty(_confirmPasswordError))
        {
            return;
        }

        try
        {
            _isLoading = true;
            _generalError = string.Empty;

            var payload = new 
            { 
                currentPassword = _model.CurrentPassword, 
                newPassword = _model.NewPassword 
            };
            
            var response = await HttpClient.PostAsJsonAsync("/api/v1/identity/users/change-password", payload);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Password changed successfully! You will be logged out.", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                
                // Try to parse error message
                try
                {
                    var errorJson = System.Text.Json.JsonDocument.Parse(errorContent);
                    if (errorJson.RootElement.TryGetProperty("message", out var messageProp))
                    {
                        _generalError = messageProp.GetString() ?? "Failed to change password";
                    }
                    else
                    {
                        _generalError = "Failed to change password. Please try again.";
                    }
                }
                catch
                {
                    _generalError = "Failed to change password. Please try again.";
                }
                
                // Check if it's current password error
                if (_generalError.Contains("Current password is incorrect", StringComparison.OrdinalIgnoreCase))
                {
                    _currentPasswordError = "Current password is incorrect";
                    _generalError = string.Empty;
                }
            }
        }
        catch (Exception ex)
        {
            _generalError = $"An unexpected error occurred: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    private void Cancel() => MudDialog.Cancel();
    
    private class ChangePasswordModel
    {
        public string CurrentPassword { get; set; } = string.Empty;
        public string NewPassword { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
