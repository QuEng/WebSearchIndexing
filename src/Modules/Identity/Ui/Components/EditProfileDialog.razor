@inject HttpClient HttpClient
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-4">Edit Profile</MudText>
        
        <MudTextField 
            @bind-Value="_model.FirstName"
            Label="First Name"
            Variant="Variant.Outlined"
            Required="true"
            Class="mb-3"
            Error="@(!string.IsNullOrEmpty(_firstNameError))"
            ErrorText="@_firstNameError" />
            
        <MudTextField 
            @bind-Value="_model.LastName"
            Label="Last Name"
            Variant="Variant.Outlined"
            Required="true"
            Class="mb-3"
            Error="@(!string.IsNullOrEmpty(_lastNameError))"
            ErrorText="@_lastNameError" />

        @if (!string.IsNullOrEmpty(_generalError))
        {
            <MudAlert Severity="Severity.Error" Class="mt-3">
                @_generalError
            </MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Cancel</MudButton>
        <MudButton 
            Color="Color.Primary" 
            Variant="Variant.Filled"
            OnClick="SaveProfile"
            Disabled="@(!IsFormValid() || _isLoading)">
            @if (_isLoading)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Saving...</span>
            }
            else
            {
                <span>Save</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code
{
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public string FirstName { get; set; } = string.Empty;
    [Parameter] public string LastName { get; set; } = string.Empty;
    
    private EditProfileModel _model = new();
    private bool _isLoading = false;
    
    private string _firstNameError = string.Empty;
    private string _lastNameError = string.Empty;
    private string _generalError = string.Empty;

    protected override void OnParametersSet()
    {
        _model.FirstName = FirstName;
        _model.LastName = LastName;
    }

    private bool IsFormValid()
    {
        _firstNameError = string.Empty;
        _lastNameError = string.Empty;

        bool isValid = true;

        if (string.IsNullOrWhiteSpace(_model.FirstName))
        {
            _firstNameError = "First name is required";
            isValid = false;
        }

        if (string.IsNullOrWhiteSpace(_model.LastName))
        {
            _lastNameError = "Last name is required";
            isValid = false;
        }

        return isValid;
    }
    
    private async Task SaveProfile()
    {
        if (!IsFormValid())
        {
            return;
        }

        try
        {
            _isLoading = true;
            _generalError = string.Empty;

            var payload = new 
            { 
                firstName = _model.FirstName.Trim(), 
                lastName = _model.LastName.Trim()
            };
            
            var response = await HttpClient.PutAsJsonAsync("/api/v1/identity/users/profile", payload);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Profile updated successfully!", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                
                // Try to parse error message
                try
                {
                    var errorJson = System.Text.Json.JsonDocument.Parse(errorContent);
                    if (errorJson.RootElement.TryGetProperty("message", out var messageProp))
                    {
                        _generalError = messageProp.GetString() ?? "Failed to update profile";
                    }
                    else
                    {
                        _generalError = "Failed to update profile. Please try again.";
                    }
                }
                catch
                {
                    _generalError = "Failed to update profile. Please try again.";
                }
            }
        }
        catch (Exception ex)
        {
            _generalError = $"An unexpected error occurred: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    private void Cancel() => MudDialog.Cancel();
    
    private class EditProfileModel
    {
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
    }
}
