@page "/invitations/accept"
@using WebSearchIndexing.Modules.Identity.Domain.Constants
@inject HttpClient HttpClient
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Accept _invitation</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudPaper Class="pa-6">
        @if (_isLoading)
        {
            <div class="text-center">
                <MudProgressCircular Size="Size.Large" Indeterminate="true" />
                <MudText Typo="Typo.h6" Class="mt-4">Loading _invitation...</MudText>
            </div>
        }
        else if (_invitation == null)
        {
            <div class="text-center">
                <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Large" Color="Color.Error" Class="mb-4" />
                <MudText Typo="Typo.h5" Class="mb-2">Invalid _invitation</MudText>
                <MudText Typo="Typo.body1" Class="mb-4">
                    This _invitation link is invalid, expired, or has already been used.
                </MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="GoToInvitations">
                    View My Invitations
                </MudButton>
            </div>
        }
        else
        {
            <div class="text-center mb-4">
                <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Large" Color="Color.Primary" Class="mb-4" />
                <MudText Typo="Typo.h4" Class="mb-2">Workspace _invitation</MudText>
                <MudText Typo="Typo.body1" Color="Color.Default">
                    You've been invited to join a workspace
                </MudText>
            </div>

            <MudDivider Class="mb-4" />

            <MudSimpleTable>
                <tbody>
                    <tr>
                        <td><strong>Workspace:</strong></td>
                        <td>@_invitation.TenantName</td>
                    </tr>
                    <tr>
                        <td><strong>Role:</strong></td>
                        <td>
                            <MudChip Color="GetRoleColor(_invitation.Role)" Size="Size.Small" Variant="Variant.Outlined">
                                @_invitation.Role
                            </MudChip>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Invited by:</strong></td>
                        <td>@(_invitation.InvitedBy ?? "Unknown")</td>
                    </tr>
                    <tr>
                        <td><strong>Sent:</strong></td>
                        <td>@_invitation.SentDate.ToString("MMMM dd, yyyy")</td>
                    </tr>
                    <tr>
                        <td><strong>Expires:</strong></td>
                        <td>
                            <MudText Color="@(_invitation.IsExpired ? Color.Error : Color.Default)">
                                @_invitation.ExpiresAt.ToString("MMMM dd, yyyy")
                            </MudText>
                        </td>
                    </tr>
                </tbody>
            </MudSimpleTable>

            @if (_invitation.IsExpired)
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">
                    This _invitation has expired and can no longer be accepted.
                </MudAlert>
            }
            else if (_invitation.IsAccepted)
            {
                <MudAlert Severity="Severity.Success" Class="mt-4">
                    You have already accepted this _invitation.
                </MudAlert>
            }
            else if (_invitation.IsDeclined)
            {
                <MudAlert Severity="Severity.Warning" Class="mt-4">
                    You have already declined this _invitation.
                </MudAlert>
            }
            else if (_invitation.IsRevoked)
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">
                    This _invitation has been revoked by the sender.
                </MudAlert>
            }

            <MudStack Row="true" Justify="Justify.Center" Class="mt-6" Spacing="3">
                @if (_invitation.IsPending && !_invitation.IsExpired)
                {
                    <MudButton
                        Variant="Variant.Filled"
                        Color="Color.Success"
                        StartIcon="@Icons.Material.Filled.Check"
                        OnClick="AcceptInvitationAsync"
                        Disabled="@_isProcessing">
                        @if (_isProcessing && _actionType == "accept")
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                            <MudText Class="ms-2">Accepting...</MudText>
                        }
                        else
                        {
                            <MudText>Accept _invitation</MudText>
                        }
                    </MudButton>
                    <MudButton
                        Variant="Variant.Outlined"
                        Color="Color.Error"
                        StartIcon="@Icons.Material.Filled.Close"
                        OnClick="DeclineInvitation"
                        Disabled="@_isProcessing">
                        @if (_isProcessing && _actionType == "decline")
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                            <MudText Class="ms-2">Declining...</MudText>
                        }
                        else
                        {
                            <MudText>Decline</MudText>
                        }
                    </MudButton>
                }
                else
                {
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="GoToInvitations">
                        View My Invitations
                    </MudButton>
                }
            </MudStack>
        }
    </MudPaper>
</MudContainer>

@code
{
    [Parameter]
    [SupplyParameterFromQuery]
    public string? Token { get; set; }
    
    private InvitationDto? _invitation;
    private bool _isLoading = true;
    private bool _isProcessing = false;
    private string _actionType = string.Empty;
    
    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrWhiteSpace(Token))
        {
            Snackbar.Add("Invalid _invitation link", Severity.Error);
            Navigation.NavigateTo("/invitations");
            return;
        }
        
        await LoadInvitation();
    }
    
    private async Task LoadInvitation()
    {
        try
        {
            _isLoading = true;
            var response = await HttpClient.GetAsync($"/api/v1/identity/invitations/{Token}");
            
            if (response.IsSuccessStatusCode)
            {
                _invitation = await response.Content.ReadFromJsonAsync<InvitationDto>();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                _invitation = null; // Will show invalid _invitation message
            }
            else
            {
                Snackbar.Add("Error loading _invitation details", Severity.Error);
                _invitation = null;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading _invitation: {ex.Message}", Severity.Error);
            _invitation = null;
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    private async Task AcceptInvitationAsync()
    {
        if (_invitation == null) return;
        
        try
        {
            _isProcessing = true;
            _actionType = "accept";
            
            var response = await HttpClient.PostAsync($"/api/v1/identity/invitations/{_invitation.Id}/accept", null);
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add($"Welcome to {_invitation.TenantName}! _invitation accepted successfully.", Severity.Success);
                
                // Wait a moment to show success message
                await Task.Delay(2000);
                
                // Redirect to workspaces page
                Navigation.NavigateTo("/workspaces");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Error accepting _invitation: {errorContent}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error accepting _invitation: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
            _actionType = string.Empty;
        }
    }
    
    private async Task DeclineInvitation()
    {
        if (_invitation == null) return;
        
        try
        {
            _isProcessing = true;
            _actionType = "decline";
            
            var response = await HttpClient.PostAsync($"/api/v1/identity/invitations/{_invitation.Id}/decline", null);
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add($"_invitation to {_invitation.TenantName} declined.", Severity.Info);
                
                // Wait a moment to show message
                await Task.Delay(2000);
                
                // Redirect to invitations page
                Navigation.NavigateTo("/invitations");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Error declining _invitation: {errorContent}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error declining _invitation: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isProcessing = false;
            _actionType = string.Empty;
        }
    }
    
    private void GoToInvitations()
    {
        Navigation.NavigateTo("/invitations");
    }
    
    private Color GetRoleColor(string role) => role switch
    {
        Roles.Admin => Color.Error,
        Roles.Member => Color.Primary,
        Roles.Viewer => Color.Default,
        _ => Color.Default
    };
}
